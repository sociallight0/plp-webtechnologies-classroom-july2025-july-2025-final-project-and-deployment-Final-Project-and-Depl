<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - MindSpace</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="dashboard-layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>ğŸ§  MindSpace</h2>
      </div>
      
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item active">
          <span class="nav-icon">ğŸ“Š</span>
          <span>Dashboard</span>
        </a>
        <a href="therapists.html" class="nav-item">
          <span class="nav-icon">ğŸ‘¨â€âš•ï¸</span>
          <span>My Therapists</span>
        </a>
        <a href="appointments.html" class="nav-item">
          <span class="nav-icon">ğŸ“…</span>
          <span>Appointments</span>
        </a>
        <a href="mood-tracker.html" class="nav-item">
          <span class="nav-icon">ğŸ˜Š</span>
          <span>Mood Tracker</span>
        </a>
        <a href="profile.html" class="nav-item">
          <span class="nav-icon">ğŸ‘¤</span>
          <span>Profile</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn btn-outline btn-block">
          <span>ğŸšª Logout</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Bar -->
      <header class="top-bar">
        <div class="top-bar-left">
          <h1>Dashboard</h1>
        </div>
        <div class="top-bar-right">
          <div class="user-info">
            <img id="userAvatar" src="" alt="User Avatar" class="user-avatar">
            <div>
              <p id="userName" class="user-name">Loading...</p>
              <p class="user-role">Patient</p>
            </div>
          </div>
        </div>
      </header>

      <!-- Dashboard Content -->
      <div class="dashboard-content">
        <!-- Welcome Card -->
        <div class="welcome-card card">
          <h2 id="welcomeMessage">Welcome back!</h2>
          <p class="text-muted">Here's an overview of your mental wellness journey</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card card">
            <div class="stat-icon" style="background-color: var(--secondary-green);">ğŸ‘¨â€âš•ï¸</div>
            <div class="stat-info">
              <h3 id="therapistCount">0</h3>
              <p>Active Therapists</p>
            </div>
          </div>

          <div class="stat-card card">
            <div class="stat-icon" style="background-color: #52B788;">ğŸ“…</div>
            <div class="stat-info">
              <h3 id="appointmentCount">0</h3>
              <p>Upcoming Sessions</p>
            </div>
          </div>

          <div class="stat-card card">
            <div class="stat-icon" style="background-color: #95D5B2;">ğŸ˜Š</div>
            <div class="stat-info">
              <h3 id="moodEntries">0</h3>
              <p>Mood Entries</p>
            </div>
          </div>

          <div class="stat-card card">
            <div class="stat-icon" style="background-color: #B7E4C7;">ğŸ“ˆ</div>
            <div class="stat-info">
              <h3 id="moodTrend">-</h3>
              <p>Mood Trend</p>
            </div>
          </div>
        </div>

        <!-- Two Column Layout -->
        <div class="dashboard-grid">
          <!-- Upcoming Appointments -->
          <div class="card">
            <div class="card-header">
              <h3>Upcoming Appointments</h3>
              <a href="appointments.html" class="link-primary">View All</a>
            </div>
            <div class="card-body">
              <div id="upcomingAppointments">
                <p class="text-center text-muted">Loading appointments...</p>
              </div>
            </div>
          </div>

          <!-- Recent Mood Entries -->
          <div class="card">
            <div class="card-header">
              <h3>Recent Mood Entries</h3>
              <a href="mood-tracker.html" class="link-primary">View All</a>
            </div>
            <div class="card-body">
              <div id="recentMoods">
                <p class="text-center text-muted">Loading mood entries...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header">
            <h3>Quick Actions</h3>
          </div>
          <div class="card-body">
            <div class="quick-actions">
              <a href="appointments.html" class="action-btn">
                <span class="action-icon">ğŸ“…</span>
                <span>Book Appointment</span>
              </a>
              <a href="mood-tracker.html" class="action-btn">
                <span class="action-icon">ğŸ˜Š</span>
                <span>Log Mood</span>
              </a>
              <a href="therapists.html" class="action-btn">
                <span class="action-icon">ğŸ‘¨â€âš•ï¸</span>
                <span>Find Therapist</span>
              </a>
              <a href="profile.html" class="action-btn">
                <span class="action-icon">âš™ï¸</span>
                <span>Settings</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="js/db.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>

  <script>
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', async () => {
      // CRITICAL: Wait for database to be ready first
      try {
        await window.dbReadyPromise;
      } catch (error) {
        console.error('Failed to initialize database:', error);
        alert('Database initialization failed. Please refresh the page.');
        return;
      }

      // Check authentication
      const isAuth = await Auth.requireAuth();
      if (!isAuth) return;

      // Get current user
      const user = await Auth.getCurrentUser();
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // Update user info
      document.getElementById('userName').textContent = user.fullName;
      document.getElementById('userAvatar').src = user.profileImage;
      document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.fullName.split(' ')[0]}!`;

      // Load dashboard data
      await loadDashboardData(user.id);

      // Logout handler
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (confirm('Are you sure you want to logout?')) {
          await Auth.logout();
        }
      });
    });

    async function loadDashboardData(userId) {
      try {
        // Get therapist count
        const userTherapists = await mindspaceDB.getByIndex('userTherapists', 'userId', userId);
        document.getElementById('therapistCount').textContent = userTherapists.length;

        // Get upcoming appointments
        const allAppointments = await mindspaceDB.getByIndex('appointments', 'userId', userId);
        const upcomingAppointments = allAppointments.filter(apt => {
          const aptDate = new Date(apt.date + ' ' + apt.time);
          return aptDate > new Date() && apt.status !== 'cancelled';
        }).sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
        
        document.getElementById('appointmentCount').textContent = upcomingAppointments.length;
        displayUpcomingAppointments(upcomingAppointments.slice(0, 3));

        // Get mood entries
        const moods = await mindspaceDB.getByIndex('moods', 'userId', userId);
        document.getElementById('moodEntries').textContent = moods.length;

        // Get mood trend
        if (moods.length > 0) {
          const trend = MoodUtils.getMoodTrend(moods.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
          document.getElementById('moodTrend').textContent = trend === 'improving' ? 'ğŸ“ˆ Improving' : 
                                                             trend === 'declining' ? 'ğŸ“‰ Declining' : 
                                                             'â¡ï¸ Stable';
        }

        // Display recent moods
        displayRecentMoods(moods.slice(0, 5));

      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    async function displayUpcomingAppointments(appointments) {
      const container = document.getElementById('upcomingAppointments');
      
      if (appointments.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No upcoming appointments</p>';
        return;
      }

      let html = '<div class="appointment-list">';
      for (const apt of appointments) {
        const therapist = await mindspaceDB.get('therapists', apt.therapistId);
        html += `
          <div class="appointment-item">
            <div class="appointment-info">
              <p class="appointment-therapist">${therapist ? therapist.name : 'Therapist'}</p>
              <p class="appointment-time">${DateUtils.formatDate(apt.date)} at ${apt.time}</p>
            </div>
            <span class="badge badge-success">${apt.duration} min</span>
          </div>
        `;
      }
      html += '</div>';
      container.innerHTML = html;
    }

    function displayRecentMoods(moods) {
      const container = document.getElementById('recentMoods');
      
      if (moods.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No mood entries yet</p>';
        return;
      }

      let html = '<div class="mood-list">';
      moods.forEach(mood => {
        const moodData = MoodUtils.getMoodByName(mood.mood);
        html += `
          <div class="mood-item">
            <div class="mood-emoji">${moodData ? moodData.emoji : 'ğŸ˜Š'}</div>
            <div class="mood-info">
              <p class="mood-name">${mood.mood}</p>
              <p class="mood-date">${DateUtils.formatDateShort(mood.date)}</p>
            </div>
            <div class="mood-intensity">
              <span class="intensity-badge">${mood.intensity}/10</span>
            </div>
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }
  </script>
</body>
</html>
